---
output: github_document
editor_options: 
  chunk_output_type: console
---
<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.show = "hold",
  comment = "#>",
  fig.path = "man/figures/README-"
)
```

# <img src="https://i.imgur.com/vTLlhbp.png" align="right" height=88 /> Analyze forest diversity and dynamics

[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/forestgeo/fgeo.svg?branch=master)](https://travis-ci.org/forestgeo/fgeo)
[![Coverage status](https://codecov.io/gh/forestgeo/fgeo/branch/master/graph/badge.svg)](https://codecov.io/github/forestgeo/fgeo?branch=master)
[![CRAN status](https://www.r-pkg.org/badges/version/fgeo)](https://cran.r-project.org/package=fgeo)

```{r, echo=FALSE}
# Creates a functional link when used with DT table.
fgeo_link <- function(package, topic = NULL) {
  end <- glue::glue(">{package}")
  if (!is.null(topic)) {end <- glue::glue("/reference/>{topic}")}
  glue::glue("<a href=https://forestgeo.github.io/{package}{end}</a>")
}

link_core <- function(pattern) {
  core <- fgeo_to_attach()()
  fgeo_link(core[grepl(pattern, core)])
}

analyze <- "analyze"
visualize <- "map"
manipulate <- "tool"
datasets <- "x"
```

__fgeo__ helps you to install, load, and access the documentation of multiple packages to analyze forest diversity and dynamics. It allows you to manipulate and plot [ForestGEO](http://www.forestgeo.si.edu/) data, and to do common analyses including abundance, demography, and species-habitats associations.

* [Search functions and datasets](https://forestgeo.github.io/fgeo/articles/siteonly/reference.html)
* [Try __fgeo__ online](https://bit.ly/fgeo-demo)
* [Ask questions, report bugs, or propose features](https://github.com/forestgeo/fgeo/issues/new)

## Installation

Make sure your R environment is as follows:

* R version is recent
* All packages are updated (run `update.packages()`)
* No other R session is running
* Current R session is clean (click _Session > Restart R_)

Setup the "repos" option to include ForestGEO's CRAN-like repository, then install all __fgeo__ packages with `install.packages()`:

```R
options(
  repos = c(
    CRAN = "https://cran.rstudio.com/",
    forestgeo = "https://forestgeo.github.io/drat"
  )
)

install.packages("fgeo")
```

* Update all packages with [`update.packages()`](https://www.rdocumentation.org/packages/utils/versions/3.5.2/topics/update.packages) (you may use `ask = FALSE`).
* Remove packages with [`remove.packages()`](https://www.rdocumentation.org/packages/utils/versions/3.5.2/topics/remove.packages), e.g. `remove.packages(c("fgeo.plot", "fgeo.analyze"))`.

This setup lasts for the current R session only.

<details> <summary><strong>Setup the "repos" option for every R session</strong></summary>

To setup the "repos" option to include ForestGEO's CRAN-like repository in every R session, open .Rprofile (e.g. with [`usethis::edit_r_profile()`](https://usethis.r-lib.org/reference/edit.html)) and add this code:

```R
.First <- function() {
  options(
    repos = c(
      CRAN = "https://cran.rstudio.com/",
      forestgeo = "https://forestgeo.github.io/drat"
    )
  )
}
```

Then save .Rprofile, close it, and restart R.

</details>

<details> <summary><strong>Tips to avoid or fix common installation problems</strong></summary>

#### Update R, RStudio, and R packages

* [How?](https://fgeo.netlify.com/2018/02/08/2018-02-08-update-r-rstudio-and-r-packages/)
* [Why?](https://fgeo.netlify.com/2018/03/06/2018-03-06-should-i-update-all-my-r-packages-frequently-yes-no-why/)

#### Instruct RStudio not to preserve your workspace between sessions

* [Why?](https://r4ds.had.co.nz/workflow-projects.html#what-is-real)

In RStudio go to _Tools > Global Options..._

<img src="https://i.imgur.com/QqPyHJu.png" align="center" height=450/>

#### Use RStudio projects (or the [__here__](https://here.r-lib.org/) package)

* [Why?](https://www.tidyverse.org/articles/2017/12/workflow-vs-script/)

<img src="https://user-images.githubusercontent.com/5856545/47810353-7d3ef900-dd19-11e8-951f-00afc2280198.png" align="center" height=350/>

#### Restart R many times each day

Press Cmd/Ctrl + Shift + F10 to restart RStudio or go to _Session > Restart R_.

#### Increase the rate limit to request downloads from GitHub

See [`usethis::browse_github_pat()`](https://usethis.r-lib.org/reference/browse_github_pat.html).

#### Prepare your system to build packages from source

Sometimes you may need to install the _source_ version of an R package (e.g. from CRAN or GitHub). 

* [How?](https://usethis.r-lib.org/articles/articles/usethis-setup.html#prepare-your-system-to-build-packages-from-source)

#### Troubleshoot: error: X11 library is missing: install XQuartz ...

If you are a mac user, [__fgeo.krig__](https://forestgeo.github.io/fgeo.krig/) may fail to install with the error below. Install XQuartz from <https://www.xquartz.org/> and try to install [__fgeo.krig__](https://forestgeo.github.io/fgeo.krig/) again.

```R
Error : .onLoad failed in loadNamespace() for 'tcltk', details:
  call: fun(libname, pkgname)
  error: X11 library is missing: install XQuartz from xquartz.macosforge.org
```

</details>



## Example

```{r example}
library(fgeo)
```

### Explore __fgeo__

On an interactive session, `fgeo_help()` and `fgeo_browse_reference()` help you to search documentation.

```
if (interactive()) {
  # To search on the viewer; accepts keywords
  fgeo_help()
  # To search on a web browser
  fgeo_browse_reference() 
}
```

### Access and manipulate data

`example_path()` allows you to access datasets stored in your R libraries.

```{r}
example_path()

(vft_file <- example_path("view/vft_4quad.csv"))
```

#### `read_<table>()`

`read_vft()` and `read_taxa()` import a ViewFullTable and ViewTaxonomy from .tsv or .csv files.

```{r}
read_vft(vft_file)
```

#### Importing multiple censuses from a directory into a list

(This and the following section don't use __fgeo__ because other packages already do this well.)

Combine `fs::dir_ls()` with `purrr::map()` to import multiple censuses from a directory into a list:

* Use `fs::dir_ls()` to create the paths to the files you want to import.
* Use `purrr::map()` to iterate over each path and apply a custom function to import them.

```{r}
library(purrr)
library(fs)

(rdata_files <- example_path("rdata"))
(paths <- fs::dir_ls(rdata_files))

# The formula syntax `~ fun(.x)` is a shortcut for `function(.x) fun(.x)`
censuses <- map(paths, ~ get(load(.x)))
censuses
```

#### Exporting multiple censuses from a list into a directory

* Use `purrr::walk2()` to map over two things in parallel -- each census to each path to a file. It is similar to `purrr::map2()` and `base::Map()` but prints nothing to the console.

```{r}
(files <- path_file(names(censuses)))
(folder <- tempdir())
(paths <- path(folder, files))

walk2(censuses, paths, ~ save(.x, file = .y))

# Confirm that the folder contains the files we just saved
path_file(dir_ls(folder, regexp = "tree"))
```

#### `pick_<what>()` and `drop_<what>()`

__fgeo__ is pipe-friendly. You may not use pipes but often they make code easier to read.

> Use %>% to emphasise a sequence of actions, rather than the object that the actions are being performed on.

-- <https://style.tidyverse.org/pipes.html>

`pick_dbh_under()`, `drop_status()` and friends pick and drop rows from a ForestGEO ViewFullTable or census table.

```{r}
(census <- censuses[[2]])

census %>% 
  pick_dbh_under(100)
```

`pick_main_stem()` and `pick_main_stemid()` pick the main stem or main stemid(s) of each tree in each census.

```{r}
stem <- download_data("luquillo_stem6_random")

dim(stem)
dim(pick_main_stem(stem))
```

#### `add_<column(s)>()`

`add_status_tree()`adds the column `status_tree` based on the status of all stems of each tree.

```{r}
stem %>% 
  select(CensusID, treeID, stemID, status) %>% 
  add_status_tree()
```

`add_index()` and friends add columns to a ForestGEO-like dataframe.

```{r}
stem %>% 
  select(gx, gy) %>% 
  add_index()
```

### Plot data

For simplicity, we will focus on only a few species.

```{r}
stem_2sp <- stem %>% 
  filter(sp %in% c("PREMON", "CASARB"))
```

`autoplot()` and friends produce different output depending on the class of input. You can create different input classes, for example, with `sp()` and `sp_elev()`:

* Use `sp(census)` to plot the column `sp` of a `census` dataset -- i.e. to plot species distribution.

```{r}
class(sp(stem_2sp))

autoplot(sp(stem_2sp))
```

* Use `sp_elev(census, elevation)` to plot the columns `sp` and `elev` of a `census` and `elevation` dataset, respectively -- i.e. to plot species distribution and topography.

```{r}
data("elevation")
class(sp_elev(stem_2sp, elevation))

autoplot(sp_elev(stem_2sp, elevation))
```

### Analyze

#### Abundance

`abundance()` and `basal_area()` calculate abundance and basal area, optionally by groups.

```{r}
abundance(
  pick_main_stem(census)
)

by_species <- group_by(census, sp)

basal_area(by_species)
```

#### Demography

`recruitment_ctfs()`, `mortality_ctfs()`, and `growth_ctfs()` calculate recruitment, mortality, and growth. They all output a list. `as_tibble()` converts the output from a list to a more convenient dataframe.

```{r}
data("tree5")

as_tibble(
  mortality_ctfs(tree5, tree6)
)
```

#### Species-habitats association

`tt_test()` runs a torus translation test to determine habitat associations of tree species. `as_tibble()` converts the output from a list to a more convenient dataframe. `summary()` helps you to interpret the result.

```{r}
# This analysis makes sense only for tree tables
tree <- download_data("luquillo_tree5_random")
data("habitat")
result <- tt_test(tree, habitat)

as_tibble(result)

summary(result)
```

## Related projects

Additional packages maintained by ForestGEO but not included in __fgeo__:

* [__fgeo.data__](https://forestgeo.github.io/fgeo.data/): Open datasets of ForestGEO.
* [__fgeo.krig__](https://forestgeo.github.io/fgeo.krig/): Analyze soils.



Other packages not maintained by ForestGEO:

* [CTFS-R Package](http://ctfs.si.edu/Public/CTFSRPackage/): The original package of CTFS functions. No longer supported by ForestGEO.
* [__BIOMASS__](https://CRAN.R-project.org/package=BIOMASS): An R package to estimate above-ground biomass in tropical forests.



## R code from recent publications by ForestGEO partners

Data have been made available as required by the journal to enable reproduction of the results presented in the paper. Please do not share these data without permission of the ForestGEO plot Principal Investigators (PIs). If you wish to publish papers based on these data, you are also required to get permission from the PIs of the corresponding ForestGEO plots.

* [Soil drivers of local-scale tree growth in a lowland tropical forest (Zemunik et al., 2018).](https://github.com/SoilLabAtSTRI/Soil-drivers-of-tree-growth)
* [Plant diversity increases with the strength of negative density dependence at the global scale (LaManna et al., 2018)](https://github.com/forestgeo/LaManna_et_al_Science)
    * Response #1: LaManna et al. 2018. Response to Comment on "Plant diversity increases with the strength of negative density dependence at the global scale" Science Vol. 360, Issue 6391, eaar3824. DOI: 10.1126/science.aar3824
    * Response #2: LaManna et al. 2018. Response to Comment on "Plant diversity increases with the strength of negative density dependence at the global scale". Science Vol. 360, Issue 6391, eaar5245. DOI: 10.1126/science.aar5245

## Information

* [Getting help](SUPPORT.md).
* [Contributing](CONTRIBUTING.md).
* [Contributor Code of Conduct](CODE_OF_CONDUCT.md).

## Acknowledgments

Thanks to all partners of ForestGEO for sharing their ideas and code. For feedback on __fgeo__, special thanks to Gabriel Arellano, Stuart Davies, Lauren Krizel, Sean McMahon, and Haley Overstreet. For all other help, I thank contributors in the the documentation of the features they helped with.
